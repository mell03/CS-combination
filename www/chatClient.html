<!DOCTYPE HTML>
<html>
<head>
 <meta charset="utf-8">

 <link rel="stylesheet" href="./main_style.css" >
 <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
 <script src="https://code.highcharts.com/highcharts.js"></script>
 <script src="https://code.highcharts.com/modules/exporting.js"></script>


 <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/themes/base/jquery-ui.css" rel="stylesheet" type="text/css"/>
 <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4/jquery.min.js"></script>
 <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8/jquery-ui.min.js"></script>

 <script src='http://114.202.97.238:10000/check_user.cgi'></script>
 <script src="http://114.202.97.238:10000/get_camera_params.cgi"></script>

 <script>
     var currentBrightness = Number('255');
     function sendBrightness(){
         currentBrightness = Number(document.getElementById('brightness').value);
         ws.send('!BRI' + currentBrightness + '?');
     }
 </script>
 <script>
  function parseServerMsg(msg){
      if(msg == "ON"){
         //alert(msg);
          //$('#led_on_off_control').innerText('OFF');
          $('#led_status').text('현재상태 : ON');
      }
      else if(msg == "OFF"){
          //alert(msg);
          //$('#led_on_off_control').innerText('ON');
          $('#led_status').text('현재상태 : OFF');
      }
      else{
          console.log('innser parse' + msg);
          if(msg.substr(0,6) == 'RESIST'){
              insertDataResist(msg.substr(6,msg.length-6));
          }
          else if(msg.substr(0,3) == 'BRI'){
              var returnBrightness = Number(msg.substr(3,3));
              console.log('returnB : ' + returnBrightness);
              console.log('currenB : ' + currentBrightness);
              if(returnBrightness!=currentBrightness){
                  ws.send('!BRI' + currentBrightness + '?');
              }
              $('#val').text(returnBrightness);


          }
      }
  }

 </script>
 <script type="text/javascript">

     var isStart = false;
     var inst ="";
         if ("WebSocket" in window)
         {

             // Let us open a web socket
             var ws = new WebSocket("ws://114.202.97.238:8090");

             ws.onopen = function()
             {
                 // Web Socket is connected, send data using send()
                 //var toSend = $('#text_input').value;

                 //alert("connected");
                // alert("Message is sent...");
             };

             ws.onmessage = function (evt)
             {
                 var received_msg = evt.data;
                 //alert("Message is received..." + "\n" + received_msg);
                 //alert(received_msg);


                 console.log('msg : ' + received_msg);

                 for(var i = 0 ;i<received_msg.length-1;i++){
                   if(received_msg.charAt(i) =='!'){
                       isStart = true;
                   }
                   else if(received_msg.charAt(i) == '?'){
                       isStart = false;
                       parseServerMsg(inst);
                       console.log('inst : ' + inst);
                       inst="";
                   }
                   else if(isStart == true && (('A'<=received_msg.charAt(i) && received_msg.charAt(i) <='Z') || ('0'<=received_msg.charAt(i) && received_msg.charAt(i) <='9'))){

                       inst+=received_msg.charAt(i);
                   }
                 }
             };

             ws.onclose = function()
             {
                 // websocket is closed.
                 //alert("Connection is closed...");
             };
         }

         else
         {
             // The browser doesn't support WebSocket
             alert("WebSocket NOT supported by your Browser!");
         }
     function sendMsg(){
         var toSend=document.getElementById('text_input').value;    //id 선언시 getElementById 사용
         ws.send(toSend);
     }
 </script>
 <script>

     var PTZ_STOP	=1;
     var TILT_UP		=2;
     var TILT_UP_STOP=1;
     var TILT_DOWN	=0;
     var TILT_DOWN_STOP=3;
     var PAN_LEFT	=6;
     var PAN_LEFT_STOP=5;
     var PAN_RIGHT	=4;
     var PAN_RIGHT_STOP=7;
     var PTZ_LEFT_UP	=93;
     var PTZ_RIGHT_UP=92;
     var PTZ_LEFT_DOWN=91;
     var PTZ_RIGHT_DOWN=90;
     var PTZ_CENTER	=25;
     var PTZ_VPATROL	=26;
     var PTZ_VPATROL_STOP=27;
     var PTZ_HPATROL	=28;
     var PTZ_HPATROL_STOP=29;
     var PTZ_PELCO_D_HPATROL=20;
     var PTZ_PELCO_D_HPATROL_STOP=21;

     var IO_ON=94;
     var IO_OFF=95;
     function decoder_control_onestep(command)
     {
         action_zone.location='http://114.202.97.238:10000/decoder_control.cgi?onestep=1&command='+command;
     }

     function decoder_control(command)
     {
         action_zone.location='http://114.202.97.238:10000/decoder_control.cgi?command='+command;
     }
     function leftclicked()
     {
         (flip&0x02)?decoder_control_onestep(PAN_RIGHT):decoder_control_onestep(PAN_LEFT);
     }
     function rightclicked()
     {
         (flip&0x02)?decoder_control_onestep(PAN_LEFT):decoder_control_onestep(PAN_RIGHT);
     }
     function downclicked()
     {
         (flip&0x01)?decoder_control_onestep(TILT_UP):decoder_control_onestep(TILT_DOWN);
     }
     function upclicked()
     {
         (flip&0x01)?decoder_control_onestep(TILT_DOWN):decoder_control_onestep(TILT_UP);
     }
 </script>

 <script>
     if(!('webkitSpeechRecognition' in window)){
         $('#recognition_result').text('지원하지 않는 브라우저입니다.');
         console.log('미지원 브라우저');
     }
     else{
         var mic = new webkitSpeechRecognition();
         mic.continuous = false;
         mic.interimResults = true;
         mic.lang = 'ko-KR';
         //영어 : 'en-US'
         mic.onresult = function(e){
             var textResult = '', c = false;
             for(var i = e.resultIndex; i<e.results.length; ++i){
                 textResult += e.results[i][0].transcript;
                 c = e.results[i].isFinal;
             }
             if($('#recognition_result .cning').length <1 )
                 $('#recognition_result').html('<span class="cning"></span>');
             $('#recognition_result .cning').text(textResult);
             //if(c) $('#test .cning').removeClass('cning');
         };
         mic.onend = function(){
             $('#recognition_btn').text('시작하기');
             nowRecognizing = false;
         };
         mic.onstart = function(){
             $('#recognition_btn').text('말씀하세요');
             nowRecognizing = true;
         };
     }
 </script>
 <script>
     var nowRecognizing = false;
     function onclickB(){
         if(nowRecognizing){
             mic.stop();
         }
         else{
             mic.start();
         }
     }
 </script>

 <script>
     var chart = null;
     var var_series = [ {
         name: '가변저항',
         data: []
     }];
     var var_categories = ['1'];
     $(function () {
         chart = Highcharts.chart('container', {

             title: {
                 text: '가변저항',
                 x: -20 //center

             },
             subtitle: {
                 text: '가 변 저 항!!',
                 x: -20

             },
             xAxis: {
                 categories: var_categories
             },
             yAxis: {
                 title: {
                     text: '저항'
                 },
                 plotLines: [{
                     value: 0,
                     width: 1,
                     color: '#808080'
                 }]
             },
             tooltip: {
                 valueSuffix: 'ohm'
             },
             legend: {
                 layout: 'vertical',
                 align: 'right',
                 verticalAlign: 'middle',
                 borderWidth: 0
             },
             series: var_series

         });

     });

     function insertDataResist(data){
         var_series[0].data.push(Number(data));
         chart.update({
            char:{

            },
            series:var_series
         });
     }

     function insertData(){
         var input = document.getElementById('entry_input').value;
         var float_input = parseFloat(+input);

         if(isNaN(float_input) || input ==''){
             alert("not a number");
             return;
         }

         var_series[0].data.push(float_input);
         chart.update({
             chart: {
                 //inverted: false,
                 //polar: false
             },
             series : var_series
         });
     }
     function ledOnOff(){
         ws.send("!REVERSELED?");
     }
 </script>
</head>
<body>

<input id ="text_input" />
<button id="send_btn" onclick=sendMsg();>send</button>
<br>

<!--
<div id="sse">
 <a href="javascript:WebSocketTest()">Send Message</a>
</div>-->

<button id='recognition_btn' onclick='onclickB()' style="width:200px;height:100px;font-size:2em">시작하기</button>
<div id='recognition_result'>버튼을 클릭하고 말해주세요.</div>
<div class='led_status'>
 <button class='led_control' id='led_on_off_control' onclick='ledOnOff();'>LED ON/OFF</button>
 <div id='led_status'>현재상태 : ON</div>
</div>
<div class='led_brightness_control'>
 <div id="slider"></div>
 <input id = 'brightness' type = 'range' min = '0' max = '255' step = '1' onchange = 'sendBrightness();' value='255'/>

 Current Brightness : <span id="val">255</span>

</div>

<br>
<br>


<iframe name="action_zone" style="display:none"></iframe>

<div class='video_container'>
 <img src="http://114.202.97.238:10000/videostream.cgi?rate=0">
</div>

<button id ='camera_up' class='camera_control_btn' onclick=upclicked()>상</button>
<button class='camera_control_btn' onclick=downclicked()>하</button>
<button class='camera_control_btn' onclick=leftclicked()>좌</button>
<button class='camera_control_btn' onclick=rightclicked()>우</button>

<div id="container" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
<input id ="entry_input" />
<button class='insert_btn' onclick=insertData()>그래프 테스트</button>
<script>
    if(!('webkitSpeechRecognition' in window)){
        $('#recognition_result').text('지원하지 않는 브라우저입니다.');
        console.log('미지원 브라우저');
    }
</script>
</body>
</html>